<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Dashboard simple para monitorear la calibraci√≥n de marinado: frames, ocupaci√≥n y avances por minuto." />
  <meta name="color-scheme" content="light dark" />
  <title>Dashboard ‚Äì Calibraci√≥n Marinado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js para las gr√°ficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --muted:#6b7280; --accent:#3b82f6; --border:#e5e7eb; --text:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text)}
    .container{max-width:1200px; margin:0 auto; padding:24px}
    header{position:sticky; top:0; z-index:10; background:var(--card); box-shadow:0 1px 6px rgba(0,0,0,.06)}
    .header-inner{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:12px 24px}
    .logo{height:40px; object-fit:contain}
    h1{font-size:28px; margin:0; font-weight:700; letter-spacing:.2px}
    .btns{display:flex; gap:8px}
    .btn{padding:8px 14px; border-radius:16px; border:1px solid var(--border); background:#fff; cursor:pointer}
    .btn.primary{border-color:var(--accent); background:var(--accent); color:#fff}

    .grid{display:grid; gap:24px}
    .grid-2-1{grid-template-columns:2fr 1fr}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-1{grid-template-columns:1fr}
    @media (max-width: 980px){
      .grid-2-1, .grid-3{grid-template-columns:1fr}
    }

    .card{background:var(--card); border:1px solid var(--border); border-radius:8px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card.gauge-card{padding:8px 12px;}
    .card.gauge-card{padding:8px 12px; max-height:220px;}
    .card h2{margin:0 0 10px 0; font-size:18px}
    .muted{color:var(--muted); font-size:14px}

    .frame-grid{display:grid; gap:16px}
    .frame-grid.grid-2{grid-template-columns:repeat(2,1fr)}
    .frame{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
    .frame-title{font-weight:600; font-size:14px; margin-bottom:8px}
    .thumb{aspect-ratio:16/12; width:100%; background:#f3f4f6; border-radius:10px; overflow:hidden}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .kv{display:flex; justify-content:space-between; margin-top:8px; font-size:14px}
    .kv .label{color:var(--muted)}
    .gauge-wrap{position:relative; height:140px}
    .gauge-center{position:absolute; inset:auto 0 8px 0; text-align:center}
    .gauge-val{font-size:28px; font-weight:800; line-height:1}
    .gauge-sub{font-size:12px; color:var(--muted)}

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --card:#0f172a; --muted:#9aa4b2; --accent:#60a5fa; --border:#1f2937; --text:#e5e7eb;
      }
      .thumb{background:#111827}
    }
  </style>
</head>
<body>

  <!-- ENCABEZADO -->
  <header>
    <div class="header-inner">
      <img class="logo" src="LogoAgrosuper.png" alt="Agrosuper"
           onerror="this.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns=`+`http://www.w3.org/2000/svg`+` viewBox=`+`0 0 300 80`+`><rect width=`+`100%`+` height=`+`100%`+` fill=`+`#f3f4f6`+`/><text x=`+`50%`+` y=`+`50%`+` dominant-baseline=`+`middle`+` text-anchor=`+`middle`+` font-size=`+`16`+` fill=`+`#9ca3af`+`>Logo</text></svg>`);">
      <h1>Calibraci√≥n Marinado</h1>
      <div class="btns">
        <button id="exportBtn" class="btn" type="button" title="Descargar CSV con los datos visibles">Exportar</button>
        <button class="btn primary" type="button" onclick="alert('Actualizaci√≥n de ejemplo üöÄ')" title="Simular actualizaci√≥n de datos">Actualizar</button>
      </div>
    </div>
  </header>

  <main class="container grid">
    <!-- Secci√≥n superior: izquierda frames / derecha gauge -->
    <section class="grid grid-2-1">
      <!-- IZQUIERDA: Frames capturados -->
      <div>
        <div class="muted" style="margin-bottom:8px">
          Frames capturados (con volumen total y ocupaci√≥n L/R)
        </div>
        <div id="frames" class="frame-grid grid-2"></div>
      </div>

      <!-- DERECHA: Gauge + hist√≥ricos (apilados verticalmente) -->
      <div>
        <div class="card gauge-card">
          <h2>Avances por minuto</h2>
          <div class="gauge-wrap">
            <canvas id="gaugeChart"></canvas>
            <div class="gauge-center">
              <div id="gaugeVal" class="gauge-val" aria-live="polite">‚Äì</div>
              <div class="gauge-sub">0 a 60 avances/min</div>
            </div>
          </div>
        </div>
        <section style="margin-top:16px">
          <h2 style="margin:8px 0 12px 0; font-size:20px; font-weight:700">Hist√≥ricos del d√≠a</h2>
          <div class="grid grid-1">
            <div class="card"><h2>Promedio de volumen en cinta</h2><canvas id="volumenChart"></canvas></div>
            <div class="card"><h2>Ocupaci√≥n promedio (lado derecho)</h2><canvas id="derChart"></canvas></div>
            <div class="card"><h2>Ocupaci√≥n promedio (lado izquierdo)</h2><canvas id="izqChart"></canvas></div>
          </div>
        </section>
      </div>
    </section>

      <!-- Secci√≥n adicional: Inyectoras y Velocidad -->
      <section style="margin-top:16px">
        <h2 style="margin:8px 0 12px 0; font-size:20px; font-weight:700">Inyectoras y velocidad</h2>
        <div class="grid grid-2">
          <div class="card">
            <h2>Volumen por inyectora en el tiempo</h2>
            <canvas id="inyectorasChart"></canvas>
          </div>
          <div class="card">
            <h2>Avance x Min recomendado vs real</h2>
            <canvas id="velocidadChart"></canvas>
          </div>
        </div>
      </section>

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    // ================== DATOS MOCK (ed√≠talos a tu gusto) ==================
    const framesData = [
      { id: "frame_000001.jpg", url: "frame_000001.jpg", volumenTotal: 25, ocupacionIzq: 10, ocupacionDer: 40, nivelAlturaIzq: 0, nivelAlturaDer: 1 },
      { id: "frame_000002.jpg", url: "frame_000002.jpg", volumenTotal: 30, ocupacionIzq: 10, ocupacionDer: 50, nivelAlturaIzq: 0, nivelAlturaDer: 1 },
      { id: "frame_000003.jpg", url: "frame_000003.jpg", volumenTotal: 12.5, ocupacionIzq: 5, ocupacionDer: 20, nivelAlturaIzq: 0, nivelAlturaDer: 0 },
      { id: "frame_000004.jpg", url: "frame_000004.jpg", volumenTotal: 15, ocupacionIzq: 10, ocupacionDer: 20, nivelAlturaIzq: 0, nivelAlturaDer: 1 },
    ];
    const horas = ["1:00","2:00","3:00","4:00","5:00","6:00","7:00","8:00","9:00","10:00","11:00","12:00"];
    const volumen = [30,42,55,50,44,60,48,52,58,61,55,59];
    const der     = [35,39,42,38,46,47,45,49,50,53,52,51];
    const izq     = [28,33,31,36,40,39,38,41,45,48,44,46];
    const avancesPorMinuto = 27; // 0..60

    // Datos mock adicionales
    const horasIny = horas; // reutilizamos las mismas horas
    const iny1 = [38,42,45,47,46,48,50,52,51,53,54,55];
    const iny2 = [30,34,36,35,37,39,40,41,42,43,44,46];
    const iny3 = [25,28,30,32,31,33,35,36,37,38,39,40];
    const iny4 = [20,22,24,25,26,27,29,30,31,32,33,34];
    const velRecom = [25,26,27,27,28,28,29,29,30,30,31,31];
    const velReal  = [24,25,28,26,29,27,30,28,31,29,30,32];

    // ================== RENDER DE FRAMES ==================
    const framesRoot = document.getElementById("frames");
    // Utilidad para descargar archivos
    function download(filename, text){
      const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }
    // Generar CSV desde los datos visibles
    function exportCSV(){
      const headers = ["id","volumenTotal(%)","ocupacionIzq(%)","ocupacionDer(%)"];
      const rows = framesData.map(f => [f.id, f.volumenTotal, f.ocupacionIzq, f.ocupacionDer]);
      const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
      download("calibracion_marinado.csv", csv);
    }
    // Conectar bot√≥n Exportar
    const exportBtn = document.getElementById("exportBtn");
    if (exportBtn) exportBtn.addEventListener("click", exportCSV);

    const placeholderSVG = (txt) => "data:image/svg+xml;utf8," + encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 450'><rect width='100%' height='100%' fill='#f3f4f6'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='24' fill='#9ca3af'>${txt}</text></svg>`
    );

    framesData.forEach(f => {
      const card = document.createElement("div");
      card.className = "frame";
      card.innerHTML = `
        <div class="frame-title">${f.id}</div>
        <div class="thumb"><img alt="${f.id}"/></div>
        <div class="kv"><span class="label">Volumen total</span><span><b>${f.volumenTotal.toFixed(1)}%</b></span></div>
        <div class="kv"><span class="label">Ocupaci√≥n lado izquierdo</span><span><b>${f.ocupacionIzq.toFixed(1)}%</b></span></div>
        <div class="kv"><span class="label">Ocupaci√≥n lado derecho</span><span><b>${f.ocupacionDer.toFixed(1)}%</b></span></div>
        <div class="kv"><span class="label">Nivel altura izquierda</span><span><b>${f.nivelAlturaIzq.toFixed(1)}</b></span></div>
        <div class="kv"><span class="label">Nivel altura derecha</span><span><b>${f.nivelAlturaDer.toFixed(1)}</b></span></div>
      `;
      const img = card.querySelector("img");
      img.src = f.url;
      img.loading = "lazy";
      img.decoding = "async";
      img.alt = f.id + " (vista previa)";
      img.onerror = () => { img.src = placeholderSVG("Sin vista previa"); };
      framesRoot.appendChild(card);
    });

    // ================== CHARTS ==================
    // Gauge (media luna) para avances/min
    const gaugeCtx = document.getElementById('gaugeChart').getContext('2d');
    const gaugeMax = 60;
    const gaugeVal = Math.max(0, Math.min(gaugeMax, avancesPorMinuto));
    document.getElementById("gaugeVal").textContent = gaugeVal;
    new Chart(gaugeCtx, {
      type: 'doughnut',
      data: { datasets: [{ data: [gaugeVal, gaugeMax - gaugeVal], backgroundColor:[getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#3b82f6', '#e5e7eb'], borderWidth:0 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        circumference: 180,   // media circunferencia
        rotation: 270,        // inicia arriba
        cutout: '70%',
        plugins: { legend: { display:false }, tooltip: { enabled:false }, title: { display:false } }
      }
    });

    // L√≠neas hist√≥ricas
    const commonLineOptions = {
      responsive:true,
      scales: { y: { beginAtZero:true, max:100 } },
      plugins: { legend: { display:false }, title: { display:false } }
    };
    new Chart(document.getElementById('volumenChart'), {
      type:'line',
      data:{ labels:horas, datasets:[{ data:volumen, borderColor:'#2563eb', fill:false, tension:.35 }] },
      options: commonLineOptions
    });
    new Chart(document.getElementById('derChart'), {
      type:'line',
      data:{ labels:horas, datasets:[{ data:der, borderColor:'#ef4444', fill:false, tension:.35 }] },
      options: commonLineOptions
    });
    new Chart(document.getElementById('izqChart'), {
      type:'line',
      data:{ labels:horas, datasets:[{ data:izq, borderColor:'#16a34a', fill:false, tension:.35 }] },
      options: commonLineOptions
    });

    // Volumen por inyectora en el tiempo
    new Chart(document.getElementById('inyectorasChart'), {
      type:'line',
      data:{
        labels: horasIny,
        datasets:[
          { label:'Inyectora 1', data:iny1, borderColor:'#2563eb', fill:false, tension:.35 },
          { label:'Inyectora 2', data:iny2, borderColor:'#ef4444', fill:false, tension:.35 },
        ]
      },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true } },
        plugins:{ legend:{ display:true }, title:{ display:false } }
      }
    });
    // Velocidad recomendada vs real
    new Chart(document.getElementById('velocidadChart'), {
      type:'line',
      data:{
        labels: horasIny,
        datasets:[
          { label:'Recomendada', data:velRecom, borderColor:'#0ea5e9', fill:false, tension:.35 },
          { label:'Real',        data:velReal,  borderColor:'#f97316', fill:false, tension:.35 }
        ]
      },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true } },
        plugins:{ legend:{ display:true }, title:{ display:false } }
      }
    });
    });
  </script>
</body>
</html>